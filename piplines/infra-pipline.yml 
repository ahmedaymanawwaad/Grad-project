- job: Infrastructure
  displayName: 'Infrastructure Provisioning (VPC, EKS, Cognito, APIGW)'
  timeoutInMinutes: 120

  steps:
  - checkout: self

  - task: TerraformInstaller@1
    displayName: Install Terraform
    inputs:
      terraformVersion: latest

  # Terraform Init
  - task: AWSShellScript@1
    displayName: Terraform Init
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: $(AWS_REGION)
      scriptType: inline
      inlineScript: |
        set -euo pipefail
        cd "$(TF_DIR)"
        terraform init -input=false

  # Terraform Plan
  - task: AWSShellScript@1
    displayName: Terraform Plan
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: $(AWS_REGION)
      scriptType: inline
      inlineScript: |
        set -euo pipefail
        cd "$(TF_DIR)"

        if [ "${{ parameters.destroy }}" = "true" ]; then
          echo "Running terraform plan (DESTROY)"
          terraform plan -destroy -var-file="$(TF_VAR_FILE)" -out=tfplan
        else
          echo "Running terraform plan (APPLY)"
          terraform plan -var-file="$(TF_VAR_FILE)" -out=tfplan
        fi

  # Terraform Apply / Destroy
  - task: AWSShellScript@1
    displayName: Terraform Apply or Destroy
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: $(AWS_REGION)
      scriptType: inline
      inlineScript: |
        set -euo pipefail
        cd "$(TF_DIR)"

        if [ "${{ parameters.destroy }}" = "true" ]; then
          echo "Destroying infrastructure..."
          terraform apply -auto-approve tfplan
        else
          echo "Applying infrastructure..."
          terraform apply -auto-approve tfplan
        fi
