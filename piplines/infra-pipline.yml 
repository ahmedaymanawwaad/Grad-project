- job: Infrastructure
  displayName: 'Infrastructure Provisioning (VPC, EKS, Cognito, APIGW)'
  timeoutInMinutes: 120
  steps:
  - checkout: self

  - task: TerraformInstaller@1
    displayName: Install Terraform
    inputs:
      terraformVersion: latest

  - task: AWSShellScript@1
    displayName: Terraform Init
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: $(AWS_REGION)
      scriptType: inline
      inlineScript: |
        set -euo pipefail
        cd "$(TF_DIR)"
        terraform init -input=false -var-file=$(TF_VAR_FILE)

  # Terraform Plan (optional but recommended)
  - task: AWSShellScript@1
    displayName: Terraform Plan
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: $(AWS_REGION)
      scriptType: inline
      inlineScript: |
        set -euo pipefail
        cd "$(TF_DIR)"
        if [ ${{ parameters.destroy }} = true ]; then
          terraform plan -destroy -var-file=$(TF_VAR_FILE) -out=tfplan
        else
          terraform plan -var-file=$(TF_VAR_FILE) -out=tfplan
        fi

  # Terraform Apply or Destroy
  - task: AWSShellScript@1
    displayName: 'Terraform Apply/Destroy'
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: $(AWS_REGION)
      scriptType: inline
      inlineScript: |
        set -euo pipefail
        cd "$(TF_DIR)"
        
        # Prompt for confirmation
        echo "You are about to $([[ ${{ parameters.destroy }} == true ]] && echo 'DESTROY' || echo 'APPLY') the infrastructure."
        read -p "Type 'yes' to continue: " CONFIRM
        if [ "$CONFIRM" != "yes" ]; then
          echo "Aborting..."
          exit 1
        fi

        # Run Terraform
        if [ ${{ parameters.destroy }} = true ]; then
          terraform destroy -var-file=$(TF_VAR_FILE) -auto-approve
        else
          terraform apply -var-file=$(TF_VAR_FILE) -auto-approve
        fi
