name: $(Date:yyyyMMdd)$(Rev:.r)-Cluster-Tools
trigger: none
pr: none

parameters:
  - name: env
    type: string
    default: nonprod
    values: [nonprod, prod]

  - name: cluster_name
    type: string
    default: 'eks-platform-nonprod-cluster'

variables:
  TF_DIR: 'terraform'
  TF_VAR_FILE: '${{ parameters.env }}.tfvars'
  AWS_SERVICE_CONNECTION: 'aws-awwad'
  AWS_REGION: 'eu-central-1'

pool:
  vmImage: ubuntu-latest

jobs:
- job: tools
  displayName: Install Cluster Tools
  timeoutInMinutes: 120
  steps:
  - checkout: self

  # ---------------- Terraform ----------------
  - task: TerraformInstaller@1
    displayName: Install Terraform
    inputs:
      terraformVersion: latest

  - task: AWSShellScript@1
    displayName: Terraform Init
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: $(AWS_REGION)
      scriptType: inline
      inlineScript: |
        set -e
        cd "$(TF_DIR)"
        terraform init -input=false

  # ---------------- kubeconfig ----------------
  - task: AWSShellScript@1
    displayName: Configure kubeconfig
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: $(AWS_REGION)
      scriptType: inline
      inlineScript: |
        set -e

        CLUSTER_NAME="${{ parameters.cluster_name }}"
        cd "$(TF_DIR)"

        if [ -z "$CLUSTER_NAME" ]; then
          CLUSTER_NAME="$(terraform output -raw cluster_name 2>/dev/null || terraform output -raw eks_cluster_name)"
        fi

        echo "Using cluster: $CLUSTER_NAME"
        aws eks update-kubeconfig --name "$CLUSTER_NAME" --region "$(AWS_REGION)"
        kubectl get nodes

  # ---------------- Helm ----------------
  - task: AWSShellScript@1
    displayName: Install Helm
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: $(AWS_REGION)
      scriptType: inline
      inlineScript: |
        set -e
        if ! command -v helm >/dev/null; then
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
        fi
        helm version

  - task: AWSShellScript@1
    displayName: Add Helm repos
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: $(AWS_REGION)
      scriptType: inline
      inlineScript: |
        helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
        helm repo add argo https://argoproj.github.io/argo-helm
        helm repo add hashicorp https://helm.releases.hashicorp.com
        helm repo add bitnami https://charts.bitnami.com/bitnami
        helm repo add sonatype https://sonatype.github.io/helm3-charts
        helm repo update

  # ---------------- nginx ingress ----------------
  - task: AWSShellScript@1
    displayName: Install Nginx Ingress
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: $(AWS_REGION)
      scriptType: inline
      inlineScript: |
        helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx \
          --namespace ingress-nginx --create-namespace \
          --set controller.service.type=LoadBalancer \
          --wait --timeout 10m
        kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=ingress-nginx -n ingress-nginx --timeout=600s

  # ---------------- ArgoCD ----------------
  - task: AWSShellScript@1
    displayName: Install ArgoCD
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: $(AWS_REGION)
      scriptType: inline
      inlineScript: |
        helm upgrade --install argocd argo/argo-cd \
          --namespace argocd --create-namespace \
          --set server.service.type=LoadBalancer \
          --wait --timeout 10m
        kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-server -n argocd --timeout=600s

  # ---------------- Vault ----------------
  - task: AWSShellScript@1
    displayName: Install Vault (dev)
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: $(AWS_REGION)
      scriptType: inline
      inlineScript: |
        helm upgrade --install vault hashicorp/vault \
          --namespace vault --create-namespace \
          --set server.dev.enabled=true \
          --set server.service.type=LoadBalancer \
          --wait --timeout 10m
        kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=vault -n vault --timeout=600s

  # ---------------- SonarQube ----------------
  - task: AWSShellScript@1
    displayName: Install SonarQube
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: $(AWS_REGION)
      scriptType: inline
      inlineScript: |
        set -euo pipefail

        if ! helm repo list | grep -q bitnami; then
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update
        fi

        helm upgrade --install sonarqube bitnami/sonarqube \
          -n sonarqube --create-namespace \
          --set sysctl.enabled=false \
          --set persistence.enabled=true \
          --set persistence.size=20Gi \
          --set service.type=LoadBalancer \
          --timeout 30m \
          --wait || true

        kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=sonarqube -n sonarqube --timeout=1800s
        kubectl get svc sonarqube -n sonarqube -o wide

  # ---------------- Nexus ----------------
  - task: AWSShellScript@1
    displayName: Install Nexus
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: $(AWS_REGION)
      scriptType: inline
      inlineScript: |
        helm upgrade --install nexus sonatype/nexus-repository-manager \
          --namespace nexus --create-namespace \
          --set service.type=LoadBalancer \
          --wait --timeout 10m
        kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=nexus -n nexus --timeout=600s

  # ---------------- Output URLs & credentials ----------------
  - task: AWSShellScript@1
    displayName: Print URLs & credentials
    inputs:
      awsCredentials: $(AWS_SERVICE_CONNECTION)
      regionName: $(AWS_REGION)
      scriptType: inline
      inlineScript: |
        set -euo pipefail

        echo "========== Service URLs =========="
        echo "Nginx Ingress:"
        kubectl -n ingress-nginx get svc ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].hostname}{"\n"}'
        
        echo "ArgoCD:"
        kubectl -n argocd get svc argocd-server -o jsonpath='{.status.loadBalancer.ingress[0].hostname}{"\n"}'

        echo "Vault (dev mode):"
        kubectl -n vault get svc vault -o jsonpath='{.status.loadBalancer.ingress[0].hostname}{"\n"}'

        echo "SonarQube:"
        kubectl -n sonarqube get svc sonarqube -o jsonpath='{.status.loadBalancer.ingress[0].hostname}{"\n"}'

        echo "Nexus:"
        kubectl -n nexus get svc nexus -o jsonpath='{.status.loadBalancer.ingress[0].hostname}{"\n"}'

        echo "========== Credentials =========="
        echo "ArgoCD password:"
        kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath='{.data.password}' | base64 --decode
        echo

        echo "Vault root token (dev):"
        kubectl -n vault logs -l app.kubernetes.io/name=vault | grep 'Root Token'
        echo

        echo "SonarQube password:"
        kubectl -n sonarqube get secret sonarqube -o jsonpath='{.data.sonar-password}' | base64 --decode
        echo

        echo "Nexus password:"
        kubectl -n nexus get secret nexus-admin-password -o jsonpath='{.data.password}' | base64 --decode
        echo
